# coding: utf-8
__author__ = 'tuomao'
from model import dbsetting
from model import db_tool
import torndb

FEATURE_RATE={}
category_rate={}
FEATURE_CATEGORY_RATE={}
feature_c_rates={}
features=[]
FEARURE_VALUES=[0,1]
CATEGORY_VALUES=[0,1]


con=torndb.Connection(**dbsetting.DATABASE['mysql_local'])
db=db_tool.DbTool(con)

f_v_c_name=lambda f_name,f_v,c:f_name+str(f_v)+str(c)


def get_features_rate():
    global category_rate
    global features
    global feature_c_rates
    all_c_number_query='select count(package) as ct from apk_permission'
    all_c_number=float(con.get(all_c_number_query)['ct'])
    for c_v in CATEGORY_VALUES:
        get_c_rate_sql='select count(package) as ct FROM apk_permission WHERE isMalware=%d'%(c_v)
        c_v_number=con.get(get_c_rate_sql)['ct']
        category_rate[c_v]=c_v_number/all_c_number

    for f in features:
        mi=0
        for f_v in FEARURE_VALUES:
            # 计算每一个feature的0,1的比例
            f_v_number_sql='select count(package) as ct from apk_permission WHERE %s=%d'%(f['name'],f_v)
            f_v_number=con.get(f_v_number_sql)['ct']
            f_v_rate=f_v_number/all_c_number
            f['rate_%d'%(f_v)]=f_v_rate

            if f_v_rate!=0:
                for c_v in CATEGORY_VALUES:
                    # 计算每一个feature在不同类型的软件中出现和不出现的比例
                    f_c_v_number_sql='select count(package) as ct from apk_permission WHERE isMalware=%d ' \
                                     'and %s=%d'%(c_v,f['name'],f_v)
                    f_c_v_number=con.get(f_c_v_number_sql)['ct']
                    f_c_v_rate = f_c_v_number/all_c_number
                    feature_c_rates[f_v_c_name(f['name'],f_v,c_v)]=f_c_v_rate

                    temp=f_c_v_rate*(f_c_v_rate/(f_v_rate*category_rate[c_v]))
                    mi+=temp

        # 计算feature的mi
        f['mi']=mi

def main():
    global features
    features=db.get_permissions()
    features=[dict(f) for f in features]
    get_features_rate()
    features.sort(key=lambda d:d['mi'],reverse=True)

    feature_number=30
    features=features[0:feature_number]
    attr=''
    for f in features:
        attr=attr+f['name']+','
    attr=attr.rstrip(',')
    sql='select isMalware,%s from apk_permission'%(attr)
    print(sql)

main()
