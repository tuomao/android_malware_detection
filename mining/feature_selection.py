# coding: utf-8
__author__ = 'tuomao'
from model import dbsetting
from model import db_tool
import torndb

FEATURE_RATE={}
category_rate={}
FEATURE_CATEGORY_RATE={}
feature_c_rates={}
features=[]
FEARURE_VALUES=[0,1]
CATEGORY_VALUES=[0,1]


con=torndb.Connection(**dbsetting.DATABASE['mysql'])
db=db_tool.DbTool(con)

f_v_c_name=lambda f_name,f_v,c:f_name+f_v+c


def get_features_rate(count):
    all_c_number_query='select count(package) from apk_permission'
    all_c_number=con.get(all_c_number_query)
    for c_v in CATEGORY_VALUES:
        get_c_rate_sql='select count(package) FROM apk_permission WHERE isMalware=%d'%(c_v)
        c_v_number=con.get(get_c_rate_sql)
        category_rate[c_v]=c_v_number/all_c_number

    for f_name,f_value in features:
        mi=0
        for f_v in FEARURE_VALUES:
            # 计算每一个feature的0,1的比例
            f_v_number_sql='select count(package) from apk_permission WHERE %s=%d'%(f_name,f_v)
            f_v_number=con.get(f_v_number_sql)
            f_v_rate=f_v_number/all_c_number
            features[f_name].set('rate_%d'%(f_v),f_v_rate)

            for c_v in CATEGORY_VALUES:
                # 计算每一个feature在不同类型的软件中出现和不出现的比例
                f_c_v_number_sql='select count(package) from apk_permission WHERE is_malware=%d ' \
                                 'and %s=%d'(c_v,f_name,c_v)
                f_c_v_number=con.get(f_c_v_number_sql)
                f_c_v_rate = f_c_v_number/all_c_number
                feature_c_rates[f_v_c_name(f_name,f_v,c_v)]=f_c_v_rate

                # 计算feature的mi

                features[f_name].set('mi',mi)

def get_features():
    db.get_permissions()


