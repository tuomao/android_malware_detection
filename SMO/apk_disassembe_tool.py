#coding:utf-8
import argparse
import multiprocessing
import sys

import torndb
from androguard.core.bytecodes.apk import APK
from androguard.misc import AnalyzeAPK

reload(sys)
sys.setdefaultencoding("utf-8")
PERMISSIONS={}
db1=torndb.Connection("120.27.92.166","apk1",user="root",password="112112")
db=torndb.Connection("120.27.92.166","apk",user="root",password="112112")
def extract_apk_permisson(name,category):
    path = '/media/新加卷/begin_android_english/'+category+'/'+name+'.apk'
    try:
        apk=APK(path)
        if apk.is_valid_APK():
            package=apk.get_package()
            permissions=apk.get_permissions()
            # clean repeat permission
            simple_permissions=set()
            for p in permissions:
                p=p.split('.')[-1]
                if PERMISSIONS.has_key(p):
                    simple_permissions.add(p)

            insert_sql='insert into apk_permission(package,category'
            attrs=','

            for permission in simple_permissions:
                    attrs=attrs+permission+','

            attrs=attrs.rstrip(',')
            values="values ('%s','%s',"%(package,category)
            for i in range(len(simple_permissions)):
                values=values+'1,'
            values=values.rstrip(',')
            values=values+')'

            insert_sql=insert_sql+attrs+') '+values

            #print insert_sql
            db.insert(insert_sql)

            print ('analysis %s'%(path))
        else:
            print('%s is not valid apk'%(path))
    except:

        etype, evalue, tracebackObj = sys.exc_info()[:3]
        print ('apk:%s errortype:%s errorvalue:%s'%(path,etype,evalue))
    finally:
        sql = "update apk set state = 0 where package='%s'"%name
        print sql
        db1.update(sql)
        print 1

def get_permissions():
    global PERMISSIONS
    sql='select * from permission'

    result=db.query(sql)
    PERMISSIONS={ item['name']:{'protectionLevel':item['protectionLevel'],'permissionGroup':item['permissionGroup']} for item in result }

def get_un_analysis_files():
    sql='select package,category from apk where state = 1'
    result=db1.query(sql)
    return result

def mutil_process_analysis():
    pool=multiprocessing.Pool(processes=args.process)
    files=get_un_analysis_files()
    for file in files:
        print file['package']
        pool.apply(extract_apk_permisson,(file['package'].strip(),file['category'].strip()))
    pool.close()
    pool.join()
    print('finish work')

if __name__=='__main__':
    parser = argparse.ArgumentParser()
    parser.add_argument("-P", "--process", default=30,type=int,
                        help="process number")
    args=parser.parse_args()
    get_permissions()
    mutil_process_analysis()



