# coding: utf-8
import MySQLdb

__author__ = 'tuomao'
from bs4 import BeautifulSoup
import setting
mysql_con=MySQLdb.connect(**setting.DATABASE['mysql'])

def get_file_content(file_path):
    file=open(file_path,'r')
    content=file.read()
    return content

def get_permissions(content):
    bs=BeautifulSoup(content)
    permissions=bs.find_all('permission')
    _permissions=[]
    for permission in permissions:
        per={
            'name':permission.attrs.get('android:name','').split('.')[-1],
            'group':permission.attrs.get('android:permissiongroup',''),
            'protectionLevel':permission.attrs.get('android:protectionlevel','')
        }
        _permissions.append(per)
    return _permissions
def main():
    content=get_file_content('data/manifest.xml')
    permissions=get_permissions(content)
    cursor=mysql_con.cursor()
    create_table_sql="create table apk_permission(package VARCHAR (255),isMalware int,"
    for permission in permissions:
        if permission:
            # create_table_sql="%s %s int,"%(create_table_sql,permission.get('name'))
            insert_sql="insert into permission(name,protectionLevel,permissionGroup) VALUES " \
                       "('%s','%s','%s')"%(permission.get('name'),permission.get('protectionLevel'),permission.get('group'))
        cursor.execute(insert_sql)
    create_table_sql=create_table_sql+"PRIMARY KEY (package))"
    cursor.execute(create_table_sql)
    mysql_con.commit()
    cursor.close()
    mysql_con.close()
main()