# coding: utf-8
import os
import time

__author__ = 'tuomao'
import requests
import multiprocessing
SAVE_DIR='./'
TASK_NUM=3185
FINISH_TASK_NUM=0
FAIL_NUM=0
FALI_TASKS=[]
def downloader(url):
    global TASK_NUM
    global FINISH_TASK_NUM
    global FAIL_NUM
    global FALI_TASKS
    try:
        url=eval(url)
        for apk_url,category in url.items():
            save_dir=SAVE_DIR+category
            filename=apk_url.split('/')[-1]
            save_path=save_dir+'/'+filename
            if not os.path.exists(save_dir):
                os.makedirs(save_dir)

            if (not os.path.exists(save_path)) or os.stat(save_path).st_size==0:
                print('downloading: '+apk_url)
                result=requests.get(apk_url).content
                file=open(save_path,'wb+')
                file.write(result)
                file.flush()
                file.close()
            else:
                print(save_path+'is exits')
            FINISH_TASK_NUM=FINISH_TASK_NUM+1
    except:
            FAIL_NUM=FAIL_NUM+1
            FALI_TASKS.append(url)

def count_progress():
    while True:
        time.sleep(1)
        print('task number:%d,finish task number:%d,fail number:%d'%(TASK_NUM,FINISH_TASK_NUM,FAIL_NUM))

def mutil_process_download(file_path):
    file=open(file_path,'r')
    pool=multiprocessing.Pool(processes=3)
    progress=multiprocessing.Process(target=count_progress,args=())
    # progress.daemon=True
    progress.start()
    for line in file:
        pool.apply_async(downloader,(line,))

    pool.close()
    progress.terminate()
    progress.join()
    pool.join()

    print('finis task')

if __name__ == '__main__':
    mutil_process_download('./output1.txt')
